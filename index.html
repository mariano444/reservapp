<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Sistema de Reservas y Catálogo Profesional Optimizado</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/vue3-star-ratings@1.1.0/dist/vue3-star-ratings.umd.js"></script>
        <script src="https://unpkg.com/lucide-vue-next" type="text/javascript"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
        <script src="https://sdk.mercadopago.com/js/v2"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            [v-cloak] { display: none; }
            body {
                font-family: 'Poppins', sans-serif;
                transition: background-color 0.3s, color 0.3s;
            }
            .reserved-slot {
                background-color: #FEE2E2;
                color: #9CA3AF;
                cursor: not-allowed;
            }
            .break-slot {
                background-color: #E5E7EB;
                color: #6B7280;
                cursor: not-allowed;
            }
            .card {
                background-color: white;
                border-radius: 1rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
            }
            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .btn {
                transition: all 0.3s ease;
            }
            .btn:hover {
                transform: translateY(-2px);
            }
            .selected-service {
                border-color: #4F46E5;
                background-color: #EEF2FF;
            }
            .selected-date, .selected-time {
                background-color: #4F46E5;
                color: white;
            }
            .step-indicator {
                display: flex;
                justify-content: space-between;
                margin-bottom: 2rem;
                position: relative;
            }
            .step-indicator::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 0;
                right: 0;
                height: 2px;
                background-color: #E5E7EB;
                z-index: 1;
            }
            .step {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                background-color: #fff;
                border: 2px solid #E5E7EB;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: #6B7280;
                position: relative;
                z-index: 2;
                transition: all 0.3s ease;
            }
            .step.active {
                border-color: #4F46E5;
                color: #4F46E5;
                transform: scale(1.1);
            }
            .step.completed {
                background-color: #4F46E5;
                border-color: #4F46E5;
                color: #fff;
            }
            .calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 0.5rem;
            }
            .calendar-day {
                aspect-ratio: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                font-size: 0.875rem;
            }
            .calendar-day:hover:not(.selected-date):not(.disabled):not(.unavailable):not(.fully-booked) {
                background-color: #EEF2FF;
                transform: scale(1.05);
            }
            .calendar-day.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .time-slot {
                transition: all 0.2s ease;
            }
            .time-slot:hover:not(.selected-time):not(.disabled):not(.unavailable) {
                background-color: #EEF2FF;
                transform: scale(1.05);
            }
            .time-slot.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .fade-enter-active, .fade-leave-active {
                transition: opacity 0.5s ease;
            }
            .fade-enter-from, .fade-leave-to {
                opacity: 0;
            }
            .slide-fade-enter-active {
                transition: all 0.3s ease-out;
            }
            .slide-fade-leave-active {
                transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1);
            }
            .slide-fade-enter-from,
            .slide-fade-leave-to {
                transform: translateX(20px);
                opacity: 0;
            }
            .shake {
                animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
                transform: translate3d(0, 0, 0);
            }
            @keyframes shake {
                10%, 90% { transform: translate3d(-1px, 0, 0); }
                20%, 80% { transform: translate3d(2px, 0, 0); }
                30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
                40%, 60% { transform: translate3d(4px, 0, 0); }
            }
            .promo-badge {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                background-color: #10B981;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: bold;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .calendar-day.unavailable {
                background-color: #F3F4F6;
                color: #9CA3AF;
                cursor: not-allowed;
            }
            .time-slot.unavailable {
                background-color: #F3F4F6;
                color: #9CA3AF;
                cursor: not-allowed;
            }
            .calendar-day.fully-booked {
                background-color: #FEE2E2;
                cursor: not-allowed;
            }
            .calendar-day.limited-availability {
                background-color: #FEF3C7;
            }
            .limited-badge {
                position: absolute;
                top: 0;
                right: 0;
                background-color: #F59E0B;
                color: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                font-size: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .calendar-container {
                max-width: 100%;
                overflow-x: auto;
            }
            .calendar-day {
                min-height: 60px;
            }
            @media (min-width: 640px) {
                .calendar-day {
                    min-height: 80px;
                }
            }
            .skeleton {
                animation: skeleton-loading 1s linear infinite alternate;
            }
            @keyframes skeleton-loading {
                0% {
                    background-color: hsl(200, 20%, 80%);
                }
                100% {
                    background-color: hsl(200, 20%, 95%);
                }
            }
            .ff {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }
            /* Add these new styles for improved responsiveness */
            @media (max-width: 640px) {
                .step-indicator {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .step-indicator::before {
                    display: none;
                }
                .step {
                    margin-bottom: 1rem;
                }
                .calendar {
                    grid-template-columns: repeat(4, 1fr);
                }
                .calendar-day {
                    aspect-ratio: auto;
                    height: 60px;
                }
            }
            
            @media (min-width: 641px) and (max-width: 1024px) {
                .calendar {
                    grid-template-columns: repeat(5, 1fr);
                }
            }
            
            .booking-steps {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: center;
            }
            
            .booking-step {
                flex: 1 1 300px;
                max-width: 100%;
            }
            
            .time-slots {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
            }
            /* New styles for enhanced design */
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .hover-scale {
                transition: transform 0.3s ease;
            }
            .hover-scale:hover {
                transform: scale(1.05);
            }
            .shadow-soft {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
        </style>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#4F46E5',
                            secondary: '#10B981',
                            accent: '#F59E0B',
                        }
                    }
                }
            }
        </script>
    </head>
<body class="h-full">
    <div id="app" v-cloak class="min-h-screen flex flex-col bg-gray-50">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">{{ appTitle }}</h1>
                <p class="mt-1 text-sm text-gray-600">{{ appSubtitle }}</p>
            </div>
        </header>

        <main class="flex-grow">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Main content -->
                <div class="px-4 py-6 sm:px-0">
                    <div class="bg-white overflow-hidden shadow-xl sm:rounded-lg">
                        <div class="p-6 bg-white border-b border-gray-200">
                            <div class="mb-8 flex justify-center">
                                <div class="inline-flex rounded-md shadow-sm" role="group">
                                    <button @click="setCurrentTab('booking')" :class="['px-4 py-2 text-sm font-medium rounded-l-lg focus:z-10 focus:ring-2 focus:ring-primary focus:text-white', currentTab === 'booking' ? 'bg-primary text-white' : 'bg-white text-gray-900 hover:bg-gray-50']">
                                        Reservar un turno
                                    </button>
                                    <button @click="setCurrentTab('shop')" :class="['px-4 py-2 text-sm font-medium rounded-r-lg focus:z-10 focus:ring-2 focus:ring-primary focus:text-white', currentTab === 'shop' ? 'bg-primary text-white' : 'bg-white text-gray-900 hover:bg-gray-50']">
                                        Comprar Productos
                                    </button>
                                </div>
                            </div>

                            <Transition name="fade" mode="out-in">
                                <div v-if="currentTab === 'booking'" key="booking">
                                    <!-- Booking content -->
                                    <div v-if="isLoading" class="animate-pulse">
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            <div v-for="i in 6" :key="i" class="bg-gray-200 p-6 rounded-lg h-48"></div>
                                        </div>
                                    </div>
                                    <div v-else-if="filteredServices.length === 0" class="text-center py-12">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                                        </svg>
                                        <h3 class="mt-2 text-sm font-medium text-gray-900">No hay servicios disponibles</h3>
                                        <p class="mt-1 text-sm text-gray-500">Parece que no hay servicios disponibles en este momento.</p>
                                    </div>
                                    <div v-else>
                                        <div class="mb-8">
                                            <nav aria-label="Progress">
                                                <ol role="list" class="flex items-center justify-between sm:justify-start">
                                                    <li v-for="step in 5" :key="step" :class="[step > 1 ? 'sm:ml-10' : '', 'relative']">
                                                        <div v-if="step > 1" class="absolute inset-0 flex items-center" aria-hidden="true">
                                                            <div class="h-0.5 w-full bg-gray-200"></div>
                                                        </div>
                                                        <a href="#" :class="['relative flex items-center justify-center w-8 h-8 rounded-full', { 'bg-primary text-white': currentStep >= step, 'bg-white border-2 border-gray-300': currentStep < step }]">
                                                            <span v-if="currentStep > step" class="text-white">
                                                                <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                                    <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                                                                </svg>
                                                            </span>
                                                            <span v-else>{{ step }}</span>
                                                        </a>
                                                        <div class="hidden sm:block mt-2 text-xs text-center">
                                                            {{ ['Servicios', 'Fecha', 'Hora', 'Datos', 'Pago'][step - 1] }}
                                                        </div>
                                                    </li>
                                                </ol>
                                            </nav>
                                        </div>

                                        <Transition name="slide-fade" mode="out-in">
                                            <!-- Step 1: Select Services -->
                                            <div v-if="currentStep === 1" key="step1" class="space-y-6">
                                                <h2 class="text-2xl font-semibold text-gray-900">Selecciona tus Servicios</h2>
                                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
                                                    <div v-for="service in filteredServices" :key="service.id"
                                                         @click="toggleService(service)"
                                                         class="relative bg-white border rounded-lg shadow-sm p-6 cursor-pointer hover:border-primary focus:outline-none transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-md"
                                                         :class="{'border-primary ring-2 ring-primary': isServiceSelected(service), 'border-gray-200': !isServiceSelected(service)}">
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex-1 truncate">
                                                                <h3 class="text-sm font-medium text-gray-900">{{ service.name }}</h3>
                                                                <p class="mt-1 text-xs text-gray-500">{{ service.description }}</p>
                                                            </div>
                                                            <svg v-if="isServiceSelected(service)" class="h-5 w-5 text-primary" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                                                            </svg>
                                                        </div>
                                                        <div class="mt-4 flex items-center justify-between">
                                                            <p class="text-sm font-medium text-gray-900">${{ service.price }}</p>
                                                            <div class="flex items-center">
                                                                <svg class="text-yellow-400 h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                                    <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" />
                                                                </svg>
                                                                <p class="ml-1 text-sm text-gray-500">{{ service.rating.toFixed(1) }}</p>
                                                            </div>
                                                        </div>
                                                        <div v-if="service.promocion" class="promo-badge animate__animated animate__fadeIn">
                                                            {{ service.nombre_promo || 'Promoción' }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Step 2: Select Date -->
                                            <div v-else-if="currentStep === 2" key="step2" class="space-y-6">
                                                <h2 class="text-2xl font-semibold text-gray-900">Selecciona una Fecha</h2>
                                                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                                                    <div class="px-4 py-5 sm:p-6">
                                                        <div class="flex items-center justify-between mb-4">
                                                            <button @click="previousMonth" class="p-1 rounded-full hover:bg-gray-200 transition-colors duration-200">
                                                                <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                                </svg>
                                                            </button>
                                                            <h3 class="text-lg font-medium text-gray-900">{{ currentMonthName }} {{ currentYear }}</h3>
                                                            <button @click="nextMonth" class="p-1 rounded-full hover:bg-gray-200 transition-colors duration-200">
                                                                <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <div class="grid grid-cols-7 gap-2 mb-2">
                                                            <div v-for="day in daysOfWeek" :key="day" class="text-center text-sm font-medium text-gray-700">
                                                                {{ day }}
                                                            </div>
                                                        </div>
                                                        <div class="grid grid-cols-7 gap-2">
                                                            <button v-for="(day, index) in calendarDays" :key="index"
                                                                    @click="selectDate(day.date)"
                                                                    :disabled="!isDateAvailable(day.date) || isDateInPast(day.date)"
                                                                    :class="[
                                                                        'p-2 text-center text-sm leading-none rounded-lg hover:bg-gray-100 focus:z-10 transition-colors duration-200',
                                                                        isToday(day.date) ? 'font-bold border border-primary' : 'font-normal',
                                                                        day.isCurrentMonth ? 'text-gray-900' : 'text-gray-400',
                                                                        isDateAvailable(day.date) && !isDateInPast(day.date) ? 'cursor-pointer' : 'cursor-not-allowed opacity-50',
                                                                        selectedDate && day.date.toDateString() === selectedDate.toDateString() ? 'bg-primary text-white' : ''
                                                                    ]"
                                                            >
                                                                <span class="block mb-1">{{ day.date.getDate() }}</span>
                                                                <span v-if="hasLimitedAvailability(day.date)" class="block text-xs mt-1 text-accent">Limitado</span>
                                                                <span v-if="isFullyBooked(day.date)" class="block text-xs mt-1 text-red-500">Completo</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Step 3: Select Time -->
                                            <div v-else-if="currentStep === 3" key="step3" class="space-y-6">
                                                <h2 class="text-2xl font-semibold text-gray-900">Selecciona una Hora</h2>
                                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                                    <button v-for="time in availableTimes" :key="time"
                                                            @click="selectTime(time)"
                                                            :disabled="!isTimeAvailable(time)"
                                                            :class="[
                                                                'px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200',
                                                                selectedTime === time ? 'bg-primary text-white' : 'bg-white text-gray-900 border border-gray-300',
                                                                isTimeAvailable(time) ? 'hover:bg-gray-50' : 'opacity-50 cursor-not-allowed'
                                                            ]"
                                                    >
                                                        {{ formatDisplayTime(time) }}
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Step 4: Contact Information -->
                                            <div v-else-if="currentStep === 4" key="step4" class="space-y-6">
                                                <form @submit.prevent="nextStep" class="space-y-6">
                                                    <div>
                                                        <label for="name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                                        <input type="text" id="name" v-model="clientName" required
                                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm transition-colors duration-200">
                                                    </div>
                                                    <div>
                                                        <label for="phone" class="block text-sm font-medium text-gray-700">Número de Teléfono</label>
                                                        <input type="tel" id="phone" v-model="clientPhone" required pattern="[0-9]{9}"
                                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm transition-colors duration-200">
                                                    </div>
                                                    <div>
                                                        <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                                                        <input type="email" id="email" v-model="clientEmail" required
                                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm transition-colors duration-200">
                                                    </div>
                                                    <button type="submit"
                                                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                                                        Continuar
                                                    </button>
                                                </form>
                                            </div>

                                            <!-- Step 5: Summary and Payment -->
                                            <div v-else-if="currentStep === 5" key="step5" class="space-y-6">
                                                <h2 class="text-2xl font-semibold text-gray-900">Resumen y Pago de Seña</h2>
                                                <div class="bg-gray-50 p-6 rounded-lg shadow">
                                                    <dl class="space-y-6">
                                                        <div>
                                                            <dt class="text-sm font-medium text-gray-500">Servicios</dt>
                                                            <dd class="mt-1 text-sm text-gray-900">
                                                                <ul class="list-disc pl-5 space-y-1">
                                                                    <li v-for="service in selectedServices" :key="service.id">
                                                                        {{ service.name }}
                                                                        <span v-if="service.promocion" class="text-secondary font-bold">({{ service.nombre_promo || 'Promoción' }})</span>
                                                                    </li>
                                                                </ul>
                                                            </dd>
                                                        </div>
                                                        <div>
                                                            <dt class="text-sm font-medium text-gray-500">Fecha</dt>
                                                            <dd class="mt-1 text-sm text-gray-900">{{ formatDate(selectedDate) }}</dd>
                                                        </div>
                                                        <div>
                                                            <dt class="text-sm font-medium text-gray-500">Hora</dt>
                                                            <dd class="mt-1 text-sm text-gray-900">{{ selectedTime }}</dd>
                                                        </div>
                                                        <div>
                                                            <dt class="text-sm font-medium text-gray-500">Precio Total</dt>
                                                            <dd class="mt-1 text-sm text-gray-900">${{ totalPrice }}</dd>
                                                        </div>
                                                        <div>
                                                            <dt class="text-sm font-medium text-gray-500">Seña (10%)</dt>
                                                            <dd class="mt-1 text-sm text-gray-900">${{ depositAmount }}</dd>
                                                        </div>
                                                    </dl>
                                                </div>

                                                <div id="mercadopago-button-container"></div>

                                                <div class="flex items-center">
                                                    <input type="checkbox" id="terms" v-model="termsAccepted" required
                                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded transition-colors duration-200">
                                                    <label for="terms" class="ml-2 block text-sm text-gray-900">
                                                        Acepto los <a href="#" @click.prevent="showTermsModal = true" class="text-primary hover:text-primary-dark underline">términos y condiciones</a>
                                                    </label>
                                                </div>

                                                <button @click="confirmBooking" :disabled="!termsAccepted || isProcessing"
                                                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                                                    {{ isProcessing ? 'Procesando...' : 'Confirmar Reserva' }}
                                                </button>
                                            </div>
                                        </Transition>

                                        <div class="mt-8 flex flex-wrap justify-between gap-4">
                                            <button v-if="currentStep > 1" @click="previousStep"
                                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                                                Anterior
                                            </button>
                                            <button v-if="currentStep < 5" @click="nextStep"
                                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                                                Siguiente
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div v-else-if="currentTab === 'shop'" key="shop">
                                    <!-- Shop content -->
                                    <div v-if="isLoading" class="animate-pulse">
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            <div v-for="i in 6" :key="i" class="bg-gray-200 p-6 rounded-lg h-48"></div>
                                        </div>
                                    </div>
                                    <div v-else-if="filteredProducts.length === 0" class="text-center py-12">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                        </svg>
                                        <h3 class="mt-2 text-sm font-medium text-gray-900">No hay productos disponibles</h3>
                                        <p class="mt-1 text-sm text-gray-500">Parece que no hay productos disponibles en este momento.</p>
                                    </div>
                                    <div v-else>
                                        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Catálogo de Productos</h2>
                                        <div class="grid grid-cols-1 gap-y-10 sm:grid-cols-2 gap-x-6 lg:grid-cols-3 xl:grid-cols-4 xl:gap-x-8">
                                            <div v-for="product in filteredProducts" :key="product.id" class="group">
                                                <div class="w-full aspect-w-1 aspect-h-1 bg-gray-200 rounded-lg overflow-hidden xl:aspect-w-7 xl:aspect-h-8">
                                                    <img src="https://via.placeholder.com/300" :alt="product.name" class="w-full h-full object-center object-cover group-hover:opacity-75 transition-opacity duration-300">
                                                </div>
                                                <h3 class="mt-4 text-sm text-gray-700">{{ product.name }}</h3>
                                                <p class="mt-1 text-lg font-medium text-gray-900">${{ product.price }}</p>
                                                <button @click="addToCart(product)" class="mt-3 w-full bg-primary border border-transparent rounded-md py-2 px-8 flex items-center justify-center text-sm font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                                                    Agregar al Carrito
                                                </button>
                                            </div>
                                        </div>

                                        <div v-if="cart.length > 0" class="mt-12 bg-white shadow overflow-hidden sm:rounded-lg">
                                            <div class="px-4 py-5 sm:px-6">
                                                <h3 class="text-lg leading-6 font-medium text-gray-900">Carrito de Compras</h3>
                                            </div>
                                            <div class="border-t border-gray-200">
                                                <dl>
                                                    <div v-for="(item, index) in cart" :key="index" class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                                        <dt class="text-sm font-medium text-gray-500">{{ item.name }}</dt>
                                                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 flex justify-between">
                                                            <span>${{ item.price }}</span>
                                                            <button @click="removeFromCart(item)" class="text-red-600 hover:text-red-800 transition-colors duration-200">
                                                                Eliminar
                                                            </button>
                                                        </dd>
                                                    </div>
                                                </dl>
                                            </div>
                                            <div class="px-4 py-5 bg-white sm:p-6">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-lg font-semibold text-gray-900">Total: ${{ cartTotal }}</span>
                                                    <button @click="checkoutAndRedirect" :disabled="isProcessing" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                                                        {{ isProcessing ? 'Procesando...' : 'Finalizar Compra' }}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </Transition>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-white">
            <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8">
                <div class="flex justify-center space-x-6 md:order-2">
                    <a href="#" class="text-gray-400 hover:text-gray-500 transition-colors duration-200">
                        <span class="sr-only">Facebook</span>
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" />
                        </svg>
                    </a>

                    <a href="#" class="text-gray-400 hover:text-gray-500 transition-colors duration-200">
                        <span class="sr-only">Instagram</span>
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.218 2.427.465a4.902 4.902 0 011.772 1.153 4.902 4.902 0 011.153 1.772c.247.636.416 1.363.465 2.427.048 1.067.06 1.407.06 4.123v.08c0 2.643-.012 2.987-.06 4.043-.049 1.064-.218 1.791-.465 2.427a4.902 4.902 0 01-1.153 1.772 4.902 4.902 0 01-1.772 1.153c-.636.247-1.363.416-2.427.465-1.067.048-1.407.06-4.123.06h-.08c-2.643 0-2.987-.012-4.043-.06-1.064-.049-1.791-.218-2.427-.465a4.902 4.902 0 01-1.772-1.153 4.902 4.902 0 01-1.153-1.772c-.247-.636-.416-1.363-.465-2.427-.047-1.024-.06-1.379-.06-3.808v-.63c0-2.43.013-2.784.06-3.808.049-1.064.218-1.791.465-2.427a4.902 4.902 0 011.153-1.772A4.902 4.902 0 015.45 2.525c.636-.247 1.363-.416 2.427-.465C8.901 2.013 9.256 2 11.685 2h.63zm-.081 1.802h-.468c-2.456 0-2.784.011-3.807.058-.975.045-1.504.207-1.857.344-.467.182-.8.398-1.15.748-.35.35-.566.683-.748 1.15-.137.353-.3.882-.344 1.857-.047 1.023-.058 1.351-.058 3.807v.468c0 2.456.011 2.784.058 3.807.045.975.207 1.504.344 1.857.182.466.399.8.748 1.15.35.35.683.566 1.15.748.353.137.882.3 1.857.344 1.054.048 1.37.058 4.041.058h.08c2.597 0 2.917-.01 3.96-.058.976-.045 1.505-.207 1.858-.344.466-.182.8-.398 1.15-.748.35-.35.566-.683.748-1.15.137-.353.3-.882.344-1.857.048-1.055.058-1.37.058-4.041v-.08c0-2.597-.01-2.917-.058-3.96-.045-.976-.207-1.505-.344-1.858a3.097 3.097 0 00-.748-1.15 3.098 3.098 0 00-1.15-.748c-.353-.137-.882-.3-1.857-.344-1.023-.047-1.351-.058-3.807-.058zM12 6.865a5.135 5.135 0 110 10.27 5.135 5.135 0 010-10.27zm0 1.802a3.333 3.333 0 100 6.666 3.333 3.333 0 000-6.666zm5.338-3.205a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>

                    <a href="#" class="text-gray-400 hover:text-gray-500 transition-colors duration-200">
                        <span class="sr-only">Twitter</span>
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" />
                        </svg>
                    </a>
                </div>
                <div class="mt-8 md:mt-0 md:order-1">
                    <p class="text-center text-base text-gray-400">&copy; 2023 {{ appTitle }}. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>

        <Transition name="fade">
            <div v-if="notification.show" :class="['fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white', {
                'bg-green-500': notification.type === 'success',
                'bg-red-500': notification.type === 'error',
                'bg-blue-500': notification.type === 'info'
            }]">
                {{ notification.message }}
            </div>
        </Transition>

        <Transition name="fade">
            <div v-if="showTermsModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg p-8 max-w-lg w-full max-h-[80vh] overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Términos y Condiciones</h2>
                    <div class="text-gray-700 space-y-4">
                        <p>1. Al realizar una reserva, usted acepta pagar una seña del 10% del valor total del servicio.</p>
                        <p>2. La seña no es reembolsable en caso de cancelación con menos de 24 horas de anticipación.</p>
                        <p>3. Los servicios están sujetos a disponibilidad y pueden variar según la demanda.</p>
                        <p>4. Nos reservamos el derecho de modificar o cancelar reservas en circunstancias excepcionales.</p>
                        <p>5. La información personal proporcionada será tratada de acuerdo con nuestra política de privacidad.</p>
                    </div>
                    <button @click="showTermsModal = false" class="mt-6 bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors duration-200">
                        Cerrar
                    </button>
                </div>
            </div>
        </Transition>

        <Transition name="fade">
            <div v-if="showConfirmationModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg p-8 max-w-lg w-full">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">¡Reserva Confirmada!</h2>
                    <p class="text-gray-700 mb-4">Tu reserva ha sido confirmada con éxito. Hemos enviado un resumen a tu correo electrónico.</p>
                    <p class="text-gray-900 font-semibold mb-2">Número de Reserva: {{ bookingNumber }}</p>
                    <p class="text-gray-700 mb-4">Por favor, guarda este número para futuras referencias.</p>
                    <button @click="closeConfirmationModal" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors duration-200">
                        Cerrar
                    </button>
                </div>
            </div>
        </Transition>

        <div class="fixed bottom-4 right-4">
            <button @click="showChat = !showChat" class="bg-primary text-white p-3 rounded-full shadow-lg hover:bg-primary-dark transition-colors duration-300">
                <svg v-if="!showChat" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
                <svg v-else class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <Transition name="slide-fade">
            <div v-if="showChat" class="fixed bottom-20 right-4 w-80 bg-white rounded-lg shadow-xl p-4 z-50">
                <div class="h-64 overflow-y-auto mb-4 space-y-2">
                    <div v-for="(message, index) in chatMessages" :key="index" :class="['p-2 rounded-lg', {
                        'bg-gray-200 text-gray-900': message.sender === 'user',
                        'bg-primary text-white': message.sender === 'support'
                    }]">
                        {{ message.text }}
                    </div>
                </div>
                <form @submit.prevent="sendMessage" class="flex">
                    <input v-model="chatInput" type="text" placeholder="Escribe tu mensaje..." class="flex-grow border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    <button type="submit" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary-dark transition-colors duration-300">Enviar</button>
                </form>
            </div>
        </Transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        window.supabase = supabase.createClient(
                'https://tbtzlqeoogcfviojfqzg.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidHpscWVvb2djZnZpb2pmcXpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA0ODI0ODEsImV4cCI6MjA0NjA1ODQ4MX0.E4tlXIb8tTHySUkA-VMHpdrnep63prRi1PGsypCMjGQ'
            );

        createApp({
            setup() {
                // State variables
                const appTitle = ref('Reservas y Catálogo');
                const appSubtitle = ref('Reserva tus servicios y compra productos de calidad');
                const currentTab = ref('booking');
                const searchQuery = ref('');
                const services = ref([]);
                const products = ref([]);
                const selectedServices = ref([]);
                const currentStep = ref(1);
                const selectedDate = ref(null);
                const selectedTime = ref(null);
                const clientName = ref('');
                const clientPhone = ref('');
                const clientEmail = ref('');
                const paymentInfo = ref({ cardNumber: '', expiryDate: '', cvv: '' });
                const termsAccepted = ref(false);
                const cart = ref([]);
                const notification = ref({ show: false, message: '', type: 'success' });
                const showChat = ref(false);
                const chatMessages = ref([]);
                const chatInput = ref('');
                const showTermsModal = ref(false);
                const showConfirmationModal = ref(false);
                const bookingNumber = ref('');
                const loyaltyPoints = ref(0);
                const adminCode = ref(null);
                const businessHours = ref([]);
                const bookings = ref([]);
                const currentDate = ref(new Date());
                const adminPhoneNumber = ref('');
                const isProcessing = ref(false);
                const isLoading = ref(true);


                const isTimeAvailable = (time) => {
        if (!selectedDate.value) return false;

        const bookingDate = selectedDate.value.toISOString().split('T')[0];
        const existingBookings = bookings.value.filter(booking =>
            booking.date === bookingDate
        );

        for (const booking of existingBookings) {
            const bookingStartTime = booking.time;
            const bookingEndTime = booking.end_time;
            
            // Incluye el slot de fin en la reserva
            if (bookingStartTime <= time && time <= bookingEndTime) {
                return false;
            }
        }

        return true;
    };

    const getReservationInfo = (time) => {
        if (!selectedDate.value) return '';

        const bookingDate = selectedDate.value.toISOString().split('T')[0];
        const existingBooking = bookings.value.find(booking => 
            booking.date === bookingDate && 
            booking.time <= time && 
            time <= booking.end_time
        );

        if (existingBooking) {
            return `${existingBooking.time} - ${existingBooking.end_time}`;
        }

        return '';
    };
            const addMinutesToTime = (time, minutes) => {
                const [hours, mins] = time.split(':').map(Number);
                const date = new Date(2000, 0, 1, hours, mins + minutes);
                return date.toTimeString().slice(0, 5);
            };


const getServiceDuration = (serviceName) => {
    const service = services.value.find(s => s.name === serviceName);
    return service ? service.duration : 0;
};


                const getReservedSlotNumber = (time) => {
    if (!selectedDate.value) return '';

    const bookingDate = selectedDate.value.toISOString().split('T')[0];
    const dayBookings = bookings.value.filter(booking => booking.date === bookingDate);
    
    // Sort bookings by time
    dayBookings.sort((a, b) => a.time.localeCompare(b.time));

    // Find the index of the current booking
    const bookingIndex = dayBookings.findIndex(booking => booking.time === time);

    return bookingIndex !== -1 ? bookingIndex : '';
};

                // Computed properties
                const filteredServices = computed(() => {
                    return services.value.filter(service =>
                        service.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                        service.description.toLowerCase().includes(searchQuery.value.toLowerCase())
                    );
                });

                const filteredProducts = computed(() => {
                    return products.value.filter(product =>
                        product.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                        product.description.toLowerCase().includes(searchQuery.value.toLowerCase())
                    );
                });

                const cartTotal = computed(() => {
                    return cart.value.reduce((total, item) => total + item.price, 0).toFixed(2);
                });

                const totalPrice = computed(() => {
                    return selectedServices.value.reduce((total, service) => total + service.price, 0).toFixed(2);
                });

                const depositAmount = computed(() => {
                    return (parseFloat(totalPrice.value) * 0.1).toFixed(2);
                });

                const currentMonthName = computed(() => {
                    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    return months[currentDate.value.getMonth()];
                });

                const currentYear = computed(() => {
                    return currentDate.value.getFullYear();
                });

                const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

                const calendarDays = computed(() => {
                    const year = currentDate.value.getFullYear();
                    const month = currentDate.value.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startingDay = firstDay.getDay();

                    const days = [];

                    // Add days from previous month
                    for (let i = startingDay - 1; i >= 0; i--) {
                        const prevMonthLastDay = new Date(year, month, 0).getDate();
                        days.push({
                            date: new Date(year, month - 1, prevMonthLastDay - i),
                            isCurrentMonth: false
                        });
                    }

                    // Add days of current month
                    for (let i = 1; i <= daysInMonth; i++) {
                        days.push({
                            date: new Date(year, month, i),
                            isCurrentMonth: true
                        });
                    }

                    // Add days from next month
                    const remainingDays = 42 - days.length;
                    for (let i = 1; i <= remainingDays; i++) {
                        days.push({
                            date: new Date(year, month + 1, i),
                            isCurrentMonth: false
                        });
                    }

                    return days;
                });

                // Methods
                const setCurrentTab = (tab) => currentTab.value = tab;

                const fetchServices = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('services')
                            .select('*')
                            .eq('admin_unique_code', adminCode.value);
                        if (error) throw error;
                        services.value = data.map(service => ({...service, rating: Math.random() * 5}));
                    } catch (error) {
                        console.error('Error fetching services:', error);
                        showNotification('Error al cargar los servicios. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const fetchProducts = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('products')
                            .select('*')
                            .eq('admin_unique_code', adminCode.value);
                        if (error) throw error;
                        products.value = data;
                    } catch (error) {
                        console.error('Error fetching products:', error);
                        showNotification('Error al cargar los productos. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const fetchBusinessName = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('admin_configurations')
                            .select('business_name')
                            .eq('admin_unique_code', adminCode.value)
                            .single();
                        if (error) throw error;
                        appTitle.value = data.business_name;
                    } catch (error) {
                        console.error('Error fetching business name:', error);
                        showNotification('Error al cargar el nombre del negocio. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const fetchBusinessHours = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('admin_configurations')
                            .select('working_hours')
                            .eq('admin_unique_code', adminCode.value)
                            .single();
                        if (error) throw error;
                        businessHours.value = JSON.parse(data.working_hours);
                    } catch (error) {
                        console.error('Error fetching business hours:', error);
                        showNotification('Error al cargar los horarios de negocio. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const fetchBookings = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('bookings')
                            .select('*')
                            .eq('admin_unique_code', adminCode.value);
                        if (error) throw error;
                        bookings.value = data;
                    } catch (error) {
                        console.error('Error fetching bookings:', error);
                        showNotification('Error al cargar las reservas existentes. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const generateUUID = () => {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0,
                              v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                };



                const preferenceId = ref(null);
                const isProcessingPayment = ref(false);


                const initMercadoPago = async () => {
                    await createMercadoPagoPreference();
                    if (preferenceId.value) {
                        const mp = new MercadoPago('APP_USR-7e074160-3840-4194-bf27-7beee9489c9d', {
                            locale: 'es-AR'
                        });

                        const checkout = mp.checkout({
                            preference: {
                                id: preferenceId.value
                            },
                            render: {
                                container: '#mercadopago-button-container',
                                label: 'Pagar con MercadoPago',
                            }
                        });

                        checkout.on('payment_received', (data) => {
                            confirmBooking(data.status);
                        });
                    } else {
                        showNotification('Error al inicializar el pago. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const retrieveBookingDetails = () => {
                    const storedDetails = localStorage.getItem('bookingDetails');
                    if (storedDetails) {
                        const details = JSON.parse(storedDetails);
                        selectedServices.value = details.selectedServices;
                        selectedDate.value = new Date(details.selectedDate);
                        selectedTime.value = details.selectedTime;
                        clientName.value = details.clientName;
                        clientPhone.value = details.clientPhone;
                        clientEmail.value = details.clientEmail;
                        // No need to set totalPrice and depositAmount as they are computed properties
                    }
                };

                const storeBookingDetails = () => {
                    const bookingDetails = {
                        selectedServices: selectedServices.value,
                        selectedDate: selectedDate.value,
                        selectedTime: selectedTime.value,
                        clientName: clientName.value,
                        clientPhone: clientPhone.value,
                        clientEmail: clientEmail.value,
                        totalPrice: totalPrice.value,
                        depositAmount: depositAmount.value
                    };
                    localStorage.setItem('bookingDetails', JSON.stringify(bookingDetails));
                };

                const createMercadoPagoPreference = async () => {
                    try {
                        storeBookingDetails(); // Store details before creating preference
                        const response = await fetch('https://api.mercadopago.com/checkout/preferences', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer APP_USR-3549263053798148-110618-852bdcdbea13c4a27d5d95d8e7f98f5b-2079511789'
                            },
                            body: JSON.stringify({
                                items: [
                                    {
                                        title: 'Seña para reserva de servicios',
                                        unit_price: parseFloat(depositAmount.value),
                                        quantity: 1,
                                    }
                                ],
                                payer: {
                                    name: clientName.value,
                                    email: clientEmail.value,
                                    phone: {
                                        number: clientPhone.value
                                    }
                                },
                                back_urls: {
                                    success: window.location.href,
                                    failure: window.location.href,
                                    pending: window.location.href
                                },
                                auto_return: 'approved',
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const data = await response.json();
                        preferenceId.value = data.id;
                    } catch (error) {
                        console.error('Error creating MercadoPago preference:', error);
                        showNotification('Error al crear la preferencia de pago. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const formatDate = (date) => {
                    return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                };


    const simulatePaymentProcess = () => {
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve({ status: 'approved' });
            }, 2000);
        });
    };

                const toggleService = (service) => {
                    const index = selectedServices.value.findIndex(s => s.id === service.id);
                    if (index === -1) {
                        selectedServices.value.push(service);
                    } else {
                        selectedServices.value.splice(index, 1);
                    }
                };

                const isServiceSelected = (service) => {
                    return selectedServices.value.some(s => s.id === service.id);
                };

                const selectDate = (date) => {
                    if (isDateAvailable(date) && !isDateInPast(date)) {
                        selectedDate.value = date;
                        currentStep.value = 3;
                        generateAvailableTimes();
                    }
                };

                const selectTime = (time) => {
                    if (isTimeAvailable(time)) {
                        selectedTime.value = time;
                        currentStep.value = 4;
                    }
                };

                const nextStep = () => {
                    if (currentStep.value < 5) {
                        currentStep.value++;
                    }
                };

                const previousStep = () => {
                    if (currentStep.value > 1) {
                        currentStep.value--;
                    }
                };

                const fetchAdminPhoneNumber = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('admin_configurations')
                            .select('phone')
                            .eq('admin_unique_code', adminCode.value)
                            .single();
                        if (error) throw error;
                        adminPhoneNumber.value = data.phone;
                    } catch (error) {
                        console.error('Error fetching admin phone number:', error);
                        showNotification('Error al cargar el número de teléfono del administrador.', 'error');
                    }
                };

                const addToCart = (product) => {
                    cart.value.push(product);
                    showNotification('Producto agregado al carrito.', 'success');
                };

                const removeFromCart = (item) => {
                    const index = cart.value.findIndex(cartItem => cartItem.id === item.id);
                    if (index !== -1) {
                        cart.value.splice(index, 1);
                        showNotification('Producto eliminado del carrito.', 'success');
                    }
                };

                const saveOrderToDatabase = async () => {
                    try {
                        const orderItems = cart.value.map(item => ({
                            admin_unique_code: adminCode.value,
                            product_id: item.id,
                            quantity: 1, // Assuming quantity is always 1, adjust if needed
                            price: item.price,
                            product_name: item.name
                        }));

                        const { data, error } = await supabase
                            .from('order_items')
                            .insert(orderItems);

                        if (error) throw error;

                        showNotification('Pedido guardado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error saving order:', error);
                        showNotification('Error al guardar el pedido. Por favor, intenta de nuevo.', 'error');
                    }
                };

                const generateWhatsAppMessageForCart = () => {
                    let message = '🛒 *Resumen del Pedido*:\n\n';
                    cart.value.forEach(item => {
                        message += `🛍️ *${item.name}* - $${item.price}\n`;
                    });
                    message += `\n💰 *Total*: $${cartTotal.value}`;
                    return encodeURIComponent(message);
                };


                const checkoutAndRedirect = async () => {
                    isProcessing.value = true;
                    showNotification('Procesando tu pedido...', 'info');

                    try {
                        await saveOrderToDatabase();
                        const message = generateWhatsAppMessageForCart();
                        const whatsappUrl = `https://wa.me/${adminPhoneNumber.value}?text=${message}`;
                        window.open(whatsappUrl, '_blank');
                        cart.value = []; // Clear the cart after redirecting
                        showNotification('Pedido enviado por WhatsApp. Gracias por su compra!', 'success');
                    } catch (error) {
                        console.error('Error processing order:', error);
                        showNotification('Error al procesar el pedido. Por favor, intenta de nuevo.', 'error');
                    } finally {
                        isProcessing.value = false;
                    }
                };

                const showNotification = (message, type = 'info') => {
                    notification.value = { show: true, message, type };
                    setTimeout(() => {
                        notification.value.show = false;
                    }, 3000);
                };

                const resetBookingForm = () => {
                    selectedServices.value = [];
                    currentStep.value = 1;
                    selectedDate.value = null;
                    selectedTime.value = null;
                    clientName.value = '';
                    clientPhone.value = '';
                    clientEmail.value = '';
                    paymentInfo.value = { cardNumber: '', expiryDate: '', cvv: '' };
                    termsAccepted.value = false;
                };

                const sendMessage = () => {
                    if (chatInput.value.trim()) {
                        chatMessages.value.push({ sender: 'user', text: chatInput.value });
                        chatInput.value = '';
                        // Simulate a response from the support team
                        setTimeout(() => {
                            chatMessages.value.push({ sender: 'support', text: 'Gracias por tu mensaje. Un agente de soporte te responderá pronto.' });
                        }, 1000);
                    }
                };

                const closeConfirmationModal = () => {
                    showConfirmationModal.value = false;
                };

                const isDateAvailable = (date) => {
                    const dayOfWeek = date.getDay();
                    const businessHoursForDay = businessHours.value.find(bh => bh.day_of_week === dayOfWeek);
                    return businessHoursForDay && businessHoursForDay.is_working_day;
                };

                const isDateInPast = (date) => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    return date < today;
                };

                const isToday = (date) => {
                    const today = new Date();
                    return date.getDate() === today.getDate() &&
                           date.getMonth() === today.getMonth() &&
                           date.getFullYear() === today.getFullYear();
                };

                const previousMonth = () => {
                    currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() - 1, 1);
                };

                const nextMonth = () => {
                    currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 1);
                };

                const generateAvailableTimes = () => {
                    if (!selectedDate.value) return;

                    const dayOfWeek = selectedDate.value.getDay();
                    const businessHoursForDay = businessHours.value.find(bh => bh.day_of_week === dayOfWeek);

                    if (!businessHoursForDay || !businessHoursForDay.is_working_day) {
                        availableTimes.value = [];
                        return;
                    }

                    const openTime = new Date(`2000-01-01T${businessHoursForDay.open_time}`);
                    const closeTime = new Date(`2000-01-01T${businessHoursForDay.close_time}`);
                    const times = [];

                    while (openTime < closeTime) {
                        times.push(openTime.toTimeString().slice(0, 5));
                        openTime.setMinutes(openTime.getMinutes() + 30);
                    }

                    availableTimes.value = times;
                };

                const getReservationName = (date, time) => {
                    if (!date) return '';

                    const dateString = date.toISOString().split('T')[0];
                    const booking = bookings.value.find(booking =>
                        booking.date === dateString &&
                        booking.time === time &&
                        booking.status !== 'cancelled'
                    );
                    return booking ? booking.client_name : '';
                };

                const formatDisplayTime = (time) => {
                    // Convertir '09:00:00' a '09:00'
                    return time.slice(0, 5);
                };

                const availableTimes = computed(() => {
                    if (!selectedDate.value) return [];

                    const dayOfWeek = selectedDate.value.getDay();
                    const businessHoursForDay = businessHours.value.find(bh => bh.day_of_week === dayOfWeek);
                    if (!businessHoursForDay) return [];

                    const openTime = new Date(`1970-01-01T${businessHoursForDay.open_time}`);
                    const closeTime = new Date(`1970-01-01T${businessHoursForDay.close_time}`);
                    const times = [];

                    for (let time = openTime; time < closeTime; time.setMinutes(time.getMinutes() + 30)) {
                        times.push(time.toTimeString().slice(0, 8)); // Formato '09:00:00'
                    }

                    return times;
                });

                const isFullyBooked = (date)  => {
                    if (!date) return false;

                    const bookingDate = date.toISOString().split('T')[0];
                    const dayBookings = bookings.value.filter(b => b.date === bookingDate);

                    const dayOfWeek = date.getDay();
                    const businessHoursForDay = businessHours.value.find(bh => bh.day_of_week === dayOfWeek);

                    if (!businessHoursForDay || !businessHoursForDay.is_working_day) return true;

                    const openTime = new Date(`2000-01-01T${businessHoursForDay.open_time}`);
                    const closeTime = new Date(`2000-01-01T${businessHoursForDay.close_time}`);
                    let availableSlots = 0;

                    while (openTime < closeTime) {
                        const timeSlot = openTime.toTimeString().slice(0, 5);
                        if (!dayBookings.some(b => b.time === timeSlot)) {
                            availableSlots++;
                        }
                        openTime.setMinutes(openTime.getMinutes() + 30);
                    }

                    return availableSlots === 0;
                };

                const hasLimitedAvailability = (date) => {
                    if (!date) return false;

                    const bookingDate = date.toISOString().split('T')[0];
                    const dayBookings = bookings.value.filter(b => b.date === bookingDate);

                    const dayOfWeek = date.getDay();
                    const businessHoursForDay = businessHours.value.find(bh => bh.day_of_week === dayOfWeek);

                    if (!businessHoursForDay || !businessHoursForDay.is_working_day) return false;

                    const openTime = new Date(`2000-01-01T${businessHoursForDay.open_time}`);
                    const closeTime = new Date(`2000-01-01T${businessHoursForDay.close_time}`);
                    let totalSlots = 0;
                    let bookedSlots = 0;

                    while (openTime < closeTime) {
                        const timeSlot = openTime.toTimeString().slice(0, 5);
                        totalSlots++;
                        if (dayBookings.some(b => b.time === timeSlot)) {
                            bookedSlots++;
                        }
                        openTime.setMinutes(openTime.getMinutes() + 30);
                    }

                    const availabilityPercentage = (totalSlots - bookedSlots) / totalSlots;
                    return availabilityPercentage <= 0.3 && availabilityPercentage > 0;
                };

                // Watchers
                watch(selectedServices, () => {
                    if (currentStep.value === 1 && selectedServices.value.length > 0) {
                        currentStep.value = 2;
                    }
                });

                onMounted(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    adminCode.value = urlParams.get('code');
                    const paymentStatus = urlParams.get('status');
                    
                    if (paymentStatus === 'approved') {
                        confirmBooking('approved');
                    }
                    
                    if (adminCode.value) {
                        Promise.all([
                            fetchServices(),
                            fetchProducts(),
                            fetchBusinessHours(),
                            fetchBookings(),
                            fetchAdminPhoneNumber(),
                            fetchBusinessName()
                        ]).then(() => {
                            isLoading.value = false;
                        }).catch(error => {
                            console.error('Error initializing app:', error);
                            showNotification('Error al cargar los datos. Por favor, recarga la página.', 'error');
                            isLoading.value = false;
                        });
                    } else {
                        showNotification('Código de administrador no proporcionado. Algunas funciones pueden no estar disponibles.', 'warning');
                        isLoading.value = false;
                    }
                });

                watch(() => currentStep.value, (newStep) => {
                    if (newStep === 5) {
                        nextTick(() => {
                            initMercadoPago();
                        });
                    }
                });

                const isBreakTime = (time) => {
                    if (!selectedDate.value) return false;

                    const bookingDate = selectedDate.value.toISOString().split('T')[0];
                    const existingBookings = bookings.value.filter(booking =>
                        booking.date === bookingDate
                    );

                    for (const booking of existingBookings) {
                        const serviceDuration = getServiceDuration(booking.service_name);
                        const breakStartTime = new Date(`2000-01-01T${addMinutesToTime(booking.time, serviceDuration)}`);
                        const breakEndTime = new Date(`2000-01-01T${addMinutesToTime(booking.time, serviceDuration + 30)}`);
                        const currentTime = new Date(`2000-01-01T${time}`);

                        if (currentTime >= breakStartTime && currentTime < breakEndTime) {
                            return true;
                        }
                    }

                    return false;
                };

                const getReservationDuration = (time) => {
                    if (!selectedDate.value) return '';

                    const bookingDate = selectedDate.value.toISOString().split('T')[0];
                    const existingBooking = bookings.value.find(booking =>
                        booking.date === bookingDate && booking.time === time
                    );

                    if (existingBooking) {
                        return getServiceDuration(existingBooking.service_name);
                    }

                    return '';
                };

                const calculateEndTime = (startTime, duration) => {
  const [hours, minutes] = startTime.split(':').map(Number);
  let endDate = new Date(2000, 0, 1, hours, minutes + duration);
  return endDate.toTimeString().slice(0, 5);
};

<!-- Modify the confirmBooking function to include the end_time -->

const confirmBooking = async (paymentStatus) => {
  if (paymentStatus !== 'approved') {
    showNotification('El pago no fue aprobado. Por favor, intenta de nuevo.', 'error');
    return;
  }

  isProcessingPayment.value = true;
  showNotification('Procesando tu reserva...', 'info');

  try {
    retrieveBookingDetails();

    if (!selectedDate.value) {
      throw new Error('No se encontraron detalles de la reserva');
    }

    const selectedService = selectedServices.value[0]; // Assuming single service selection
    const endTime = calculateEndTime(selectedTime.value, selectedService.duration);

    const booking = {
      admin_unique_code: adminCode.value,
      client_id: generateUUID(),
      service_name: selectedServices.value.map(s => s.name).join(', '),
      date: selectedDate.value.toISOString().split('T')[0],
      time: selectedTime.value,
      end_time: endTime, // Add this line
      price: totalPrice.value,
      status: 'confirmed',
      payment_status: 'deposit_paid',
      deposit_amount: depositAmount.value,
      client_name: clientName.value,
      client_phone: clientPhone.value,
      client_email: clientEmail.value
    };

    const { data, error } = await supabase
      .from('bookings')
      .insert([booking]);

    if (error) throw error;

    showNotification('Reserva confirmada y seña procesada con éxito!', 'success');
    
    bookingNumber.value = `RES-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    showConfirmationModal.value = true;

    const message = generateWhatsAppMessage(booking);
    const whatsappUrl = `https://wa.me/${adminPhoneNumber.value}?text=${encodeURIComponent(message)}`;
    
    window.open(whatsappUrl, '_blank');

    setTimeout(() => {
      window.location.href = whatsappUrl;
    }, 2000);

    resetBookingForm();
    currentStep.value = 1;
    localStorage.removeItem('bookingDetails');
  } catch (error) {
    console.error('Error al procesar la reserva:', error);
    showNotification('Hubo un error al procesar tu reserva. Por favor, intenta de nuevo.', 'error');
  } finally {
    isProcessingPayment.value = false;
  }
};


const generateWhatsAppMessage = (booking) => {
  let message = 'Resumen de la reserva:\n\n';
  message += `Número de Reserva: ${bookingNumber.value}\n`;
  message += `Servicio: ${booking.service_name}\n`;
  message += `Fecha: ${formatDate(new Date(booking.date))}\n`;
  message += `Hora de inicio: ${booking.time}\n`;
  message += `Hora de finalización: ${booking.end_time}\n`; // Add this line
  message += `Precio Total: $${booking.price}\n`;
  message += `Seña Pagada: $${booking.deposit_amount}\n`;
  message += `Nombre: ${booking.client_name}\n`;
  message += `Teléfono: ${booking.client_phone}\n`;
  return message;
};

                // Return the reactive state and methods
                return {
                    appTitle,
                    appSubtitle,
                    isProcessingPayment,
                    currentTab,
                    searchQuery,
                    filteredServices,
                    filteredProducts,
                    selectedServices,
                    getReservationInfo,
                    getServiceDuration,
                    addMinutesToTime,
                    currentStep,
                    selectedDate,
                    getReservedSlotNumber,
                    selectedTime,
                    isTimeAvailable,
                    getReservationDuration,
                    isTimeAvailable,
                    isBreakTime,
                    getReservationDuration,
                    clientName,
                    clientPhone,
                    clientEmail,
                    paymentInfo,
                    termsAccepted,
                    cart,
                    notification,
                    showChat,
                    chatMessages,
                    chatInput,
                    showTermsModal,
                    showConfirmationModal,
                    bookingNumber,
                    loyaltyPoints,
                    currentDate,
                    currentMonthName,
                    currentYear,
                    daysOfWeek,
                    calendarDays,
                    availableTimes,
                    totalPrice,
                    depositAmount,
                    cartTotal,
                    isProcessing,
                    isLoading,
                    setCurrentTab,
                    toggleService,
                    isServiceSelected,
                    selectDate,
                    selectTime,
                    nextStep,
                    previousStep,
                    confirmBooking,
                    addToCart,
                    removeFromCart,
                    sendMessage,
                    closeConfirmationModal,
                    formatDate,
                    isDateAvailable,
                    isDateInPast,
                    isToday,
                    previousMonth,
                    nextMonth,
                    isTimeAvailable,
                    formatDisplayTime,
                    getReservationName,
                    isFullyBooked,
                    hasLimitedAvailability,
                    checkoutAndRedirect,
                    confirmBooking,
                    preferenceId,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
